<Page
    x:Class="ClipBridgeShell_CS.Views.LogsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:ClipBridgeShell_CS.Models"
    xmlns:helpers="using:ClipBridgeShell_CS.Helpers"
    x:Name="PageRoot"
    mc:Ignorable="d">

	<Page.Resources>
		<helpers:LogLevelToColorConverter x:Key="LogLevelToColorConverter"/>
	</Page.Resources>

	<Grid RowDefinitions="Auto,*,Auto" Padding="12">

		<!-- 工具条 -->
		<StackPanel Orientation="Horizontal" Spacing="8">
			<TextBox Width="240" PlaceholderText="搜索..." Text="{x:Bind VM.FilterText, Mode=TwoWay}" />

			<ToggleSwitch Header="Auto Scroll" IsOn="{x:Bind VM.AutoScroll, Mode=TwoWay}" />

			<Button Content="Scroll to Bottom" Click="OnScrollToBottomClick" />

			<Button Content="Tail" Command="{x:Bind VM.StartTailCmd}" />
			<Button Content="Stop" Command="{x:Bind VM.StopTailCmd}" />
			<Button Content="Clear View" Command="{x:Bind VM.ClearViewCmd}" />
			<Button Content="Copy" Click="OnCopyClick" />
			<Button Content="Export CSV" Command="{x:Bind VM.ExportCsvCmd}" />

			<Button Content="Delete Selected" Command="{x:Bind VM.DeleteSelectedCmd}" />
			<Button Content="Delete All" Command="{x:Bind VM.DeleteAllCmd}" />
			<Button Content="Stats" Command="{x:Bind VM.RefreshStatsCmd}" />
		</StackPanel>

		<!-- 表格布局：固定表头 + 可滚动内容 -->
		<Grid Grid.Row="1" RowDefinitions="Auto,*">
			<!-- 固定表头 -->
			<Grid x:Name="HeaderGrid" 
                  Grid.Row="0" 
                  Padding="8,6"
                  BorderThickness="0,0,0,1"
                  BorderBrush="{ThemeResource SystemControlForegroundBaseLowBrush}">
				<Grid.ColumnDefinitions>
					<ColumnDefinition x:Name="Col0" Width="{x:Bind VM.Col0Width, Mode=OneWay, Converter={StaticResource GridLengthConverter}}"/>
					<!-- 选择框 -->
					<ColumnDefinition x:Name="Col1" Width="{x:Bind VM.Col1Width, Mode=OneWay, Converter={StaticResource GridLengthConverter}}"/>
					<!-- 时间戳 -->
					<ColumnDefinition x:Name="Col2" Width="{x:Bind VM.Col2Width, Mode=OneWay, Converter={StaticResource GridLengthConverter}}"/>
					<!-- 级别 -->
					<ColumnDefinition x:Name="Col3" Width="{x:Bind VM.Col3Width, Mode=OneWay, Converter={StaticResource GridLengthConverter}}"/>
					<!-- 组件 -->
					<ColumnDefinition x:Name="Col4" Width="{x:Bind VM.Col4Width, Mode=OneWay, Converter={StaticResource GridLengthConverter}}"/>
					<!-- 分类 -->
					<ColumnDefinition x:Name="Col5" Width="*"/>
					<!-- 消息 -->
					<ColumnDefinition x:Name="Col6" Width="{x:Bind VM.Col6Width, Mode=OneWay, Converter={StaticResource GridLengthConverter}}"/>
					<!-- 异常 -->
				</Grid.ColumnDefinitions>

				<!-- 全选复选框 -->
				<CheckBox Grid.Column="0" 
                          x:Name="SelectAllCheckBox"
                          Checked="OnSelectAllChecked"
                          Unchecked="OnSelectAllUnchecked"
                          Visibility="{x:Bind VM.IsSelectionMode, Mode=OneWay}"
                          Margin="4,0" />

				<!-- 时间戳表头 -->
				<Grid Grid.Column="1">
					<Button Content="时间戳" 
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Left"
                            Click="OnTimestampHeaderClick"
                            Background="Transparent"
                            BorderThickness="0"
                            Padding="4,0" />
					<Border Width="4" 
                            HorizontalAlignment="Right"
                            Background="Transparent"
                            PointerEntered="OnCol1ResizeEnter"
                            PointerExited="OnCol1ResizeExit"
                            PointerPressed="OnCol1ResizeStart"
                            PointerMoved="OnCol1ResizeMove"
                            PointerReleased="OnCol1ResizeEnd" />
				</Grid>

				<!-- 级别表头 -->
				<Grid Grid.Column="2">
					<Button Content="级别" 
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Left"
                            Click="OnLevelHeaderClick"
                            Background="Transparent"
                            BorderThickness="0"
                            Padding="4,0" />
					<Border Width="4" 
                            HorizontalAlignment="Right"
                            Background="Transparent"
                            PointerEntered="OnCol2ResizeEnter"
                            PointerExited="OnCol2ResizeExit"
                            PointerPressed="OnCol2ResizeStart"
                            PointerMoved="OnCol2ResizeMove"
                            PointerReleased="OnCol2ResizeEnd" />
				</Grid>

				<!-- 组件表头 -->
				<Grid Grid.Column="3">
					<Button Content="组件" 
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Left"
                            Click="OnComponentHeaderClick"
                            Background="Transparent"
                            BorderThickness="0"
                            Padding="4,0" />
					<Border Width="4" 
                            HorizontalAlignment="Right"
                            Background="Transparent"
                            PointerEntered="OnCol3ResizeEnter"
                            PointerExited="OnCol3ResizeExit"
                            PointerPressed="OnCol3ResizeStart"
                            PointerMoved="OnCol3ResizeMove"
                            PointerReleased="OnCol3ResizeEnd" />
				</Grid>

				<!-- 分类表头 -->
				<Grid Grid.Column="4">
					<Button Content="分类" 
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Left"
                            Click="OnCategoryHeaderClick"
                            Background="Transparent"
                            BorderThickness="0"
                            Padding="4,0" />
					<Border Width="4" 
                            HorizontalAlignment="Right"
                            Background="Transparent"
                            PointerEntered="OnCol4ResizeEnter"
                            PointerExited="OnCol4ResizeExit"
                            PointerPressed="OnCol4ResizeStart"
                            PointerMoved="OnCol4ResizeMove"
                            PointerReleased="OnCol4ResizeEnd" />
				</Grid>

				<!-- 消息表头 -->
				<Grid Grid.Column="5">
					<Button Content="消息" 
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Left"
                            Click="OnMessageHeaderClick"
                            Background="Transparent"
                            BorderThickness="0"
                            Padding="4,0" />
					<Border Width="4" 
                            HorizontalAlignment="Right"
                            Background="Transparent"
                            PointerEntered="OnCol5ResizeEnter"
                            PointerExited="OnCol5ResizeExit"
                            PointerPressed="OnCol5ResizeStart"
                            PointerMoved="OnCol5ResizeMove"
                            PointerReleased="OnCol5ResizeEnd" />
				</Grid>

				<!-- 异常表头 -->
				<Grid Grid.Column="6">
					<Button Content="异常" 
                            HorizontalAlignment="Stretch"
                            HorizontalContentAlignment="Left"
                            Click="OnExceptionHeaderClick"
                            Background="Transparent"
                            BorderThickness="0"
                            Padding="4,0" />
				</Grid>
			</Grid>

			<!-- 可滚动内容区域 -->
			<ScrollViewer Grid.Row="1" 
                          x:Name="ContentScrollViewer"
                          ViewChanged="OnScrollViewChanged"
                          VerticalScrollMode="Auto"
                          VerticalScrollBarVisibility="Auto">
				<ItemsRepeater x:Name="List"
                               ItemsSource="{x:Bind VM.Items, Mode=OneWay}">
					<ItemsRepeater.ItemTemplate>
						<DataTemplate x:DataType="models:LogRow">
							<Grid Padding="8,6"
                                  MinHeight="28"
                                  x:Name="ItemGrid">
								<Grid.ColumnDefinitions>
									<ColumnDefinition Width="{Binding DataContext.Col0Width, ElementName=PageRoot, Converter={StaticResource GridLengthConverter}}"/>
									<!-- 选择框 -->
									<ColumnDefinition Width="{Binding DataContext.Col1Width, ElementName=PageRoot, Converter={StaticResource GridLengthConverter}}"/>
									<!-- 时间戳 -->
									<ColumnDefinition Width="{Binding DataContext.Col2Width, ElementName=PageRoot, Converter={StaticResource GridLengthConverter}}"/>
									<!-- 级别 -->
									<ColumnDefinition Width="{Binding DataContext.Col3Width, ElementName=PageRoot, Converter={StaticResource GridLengthConverter}}"/>
									<!-- 组件 -->
									<ColumnDefinition Width="{Binding DataContext.Col4Width, ElementName=PageRoot, Converter={StaticResource GridLengthConverter}}"/>
									<!-- 分类 -->
									<ColumnDefinition Width="*"/>
									<!-- 消息 -->
									<ColumnDefinition Width="{Binding DataContext.Col6Width, ElementName=PageRoot, Converter={StaticResource GridLengthConverter}}"/>
									<!-- 异常 -->
								</Grid.ColumnDefinitions>

								<!-- 选择复选框 -->
								<CheckBox Grid.Column="0" 
                                          IsChecked="{x:Bind IsSelected, Mode=TwoWay}"
                                          Checked="OnItemChecked"
                                          Unchecked="OnItemUnchecked"
                                          Visibility="{Binding DataContext.IsSelectionMode, ElementName=PageRoot, Converter={StaticResource BoolToVisibilityConverter}}"
                                          Margin="4,0"
                                          VerticalAlignment="Center" />

								<!-- 时间戳 -->
								<TextBlock Grid.Column="1"
                                           Text="{x:Bind TimeStrFull, Mode=OneWay}"
                                           FontFamily="Consolas"
                                           FontSize="13"
                                           IsTextSelectionEnabled="True"
                                           Padding="4,0"
                                           VerticalAlignment="Center" />

								<!-- 级别 -->
								<TextBlock Grid.Column="2"
                                           Text="{x:Bind LevelName, Mode=OneWay}"
                                           Foreground="{x:Bind Level, Mode=OneWay, Converter={StaticResource LogLevelToColorConverter}}"
                                           FontFamily="Consolas"
                                           FontSize="13"
                                           FontWeight="SemiBold"
                                           IsTextSelectionEnabled="True"
                                           Padding="4,0"
                                           VerticalAlignment="Center" />

								<!-- 组件 -->
								<TextBlock Grid.Column="3"
                                           Text="{x:Bind Component, Mode=OneWay}"
                                           FontFamily="Consolas"
                                           FontSize="13"
                                           IsTextSelectionEnabled="True"
                                           Padding="4,0"
                                           VerticalAlignment="Center" />

								<!-- 分类 -->
								<TextBlock Grid.Column="4"
                                           Text="{x:Bind CategoryDisplay, Mode=OneWay}"
                                           FontFamily="Consolas"
                                           FontSize="13"
                                           IsTextSelectionEnabled="True"
                                           Opacity="0.75"
                                           TextTrimming="CharacterEllipsis"
                                           Padding="4,0"
                                           VerticalAlignment="Center" />

								<!-- 消息 -->
								<TextBlock Grid.Column="5"
                                           Text="{x:Bind DisplayMessage, Mode=OneWay}"
                                           Foreground="{x:Bind Level, Mode=OneWay, Converter={StaticResource LogLevelToColorConverter}}"
                                           FontFamily="Consolas"
                                           FontSize="13"
                                           IsTextSelectionEnabled="True"
                                           TextWrapping="WrapWholeWords"
                                           Padding="4,0"
                                           VerticalAlignment="Center" />

								<!-- 异常 -->
								<TextBlock Grid.Column="6"
                                           Text="{x:Bind Exception, Mode=OneWay}"
                                           FontFamily="Consolas"
                                           FontSize="13"
                                           IsTextSelectionEnabled="True"
                                           TextWrapping="WrapWholeWords"
                                           Foreground="Red"
                                           Padding="4,0"
                                           VerticalAlignment="Center"
                                           Visibility="{x:Bind Exception,
                                                        Converter={StaticResource StringToVisibilityConverter}}" />
							</Grid>
						</DataTemplate>
					</ItemsRepeater.ItemTemplate>
				</ItemsRepeater>
			</ScrollViewer>
		</Grid>

	</Grid>
</Page>
