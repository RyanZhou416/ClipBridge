<Page
    x:Class="ClipBridgeShell_CS.Views.LogsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:ClipBridgeShell_CS.Models"
    xmlns:helpers="using:ClipBridgeShell_CS.Helpers"
    xmlns:l="using:WinUI3Localizer"
    xmlns:views="using:ClipBridgeShell_CS.Views"
    x:Name="PageRoot"
    mc:Ignorable="d">

	<Page.Resources>
		<helpers:LogLevelToColorConverter x:Key="LogLevelToColorConverter"/>
		<helpers:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
		
		<!-- 日志项模板 -->
		<DataTemplate x:Key="LogItemTemplate" x:DataType="models:LogRow">
			<Border x:Name="LogItemContainer"
                    Padding="8,2"
                    Margin="0,0,0,0"
                    HorizontalAlignment="Stretch">
				<TextBlock FontFamily="Consolas"
                           FontSize="13"
                           IsTextSelectionEnabled="True"
                           TextWrapping="Wrap"
                           TextTrimming="None"
                           Foreground="{ThemeResource SystemControlForegroundBaseHighBrush}">
					<Run Text="{x:Bind FormattedTime, Mode=OneWay}" />
					<Run Text=" " />
					<Run Text="{x:Bind FormattedLevel, Mode=OneWay}" 
                         Foreground="{x:Bind Level, Mode=OneWay, Converter={StaticResource LogLevelToColorConverter}}" />
					<Run Text=" " />
					<Run Text="{x:Bind FormattedComponent, Mode=OneWay}" />
					<Run Text=" " />
					<Run Text="{x:Bind FormattedCategory, Mode=OneWay}" 
                         Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" />
					<Run Text=" " />
					<Run Text="{x:Bind DisplayMessage, Mode=OneWay}" 
                         Foreground="{x:Bind Level, Mode=OneWay, Converter={StaticResource LogLevelToColorConverter}}" />
					<Run Text="{x:Bind ExceptionDisplay, Mode=OneWay}" 
                         Foreground="Red" />
				</TextBlock>
			</Border>
		</DataTemplate>
	</Page.Resources>

	<Grid RowDefinitions="Auto,Auto,*" Padding="12,12,12,12">
		<!-- 工具条 -->
		<StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" Margin="0,0,0,12">
			<TextBox l:Uids.Uid="LogsPage_SearchBox" Width="240" Text="{x:Bind VM.FilterText, Mode=TwoWay}" />

			<ToggleSwitch l:Uids.Uid="LogsPage_AutoScroll" IsOn="{x:Bind VM.AutoScroll, Mode=TwoWay}" />

			<Button l:Uids.Uid="LogsPage_ScrollToBottomButton" Click="OnScrollToBottomClick" />

			<Button l:Uids.Uid="LogsPage_TailButton" Command="{x:Bind VM.StartTailCmd}" />
			<Button l:Uids.Uid="LogsPage_RefreshButton" Command="{x:Bind VM.RefreshLogsCmd}" />
			<Button l:Uids.Uid="LogsPage_TestLogButton" Command="{x:Bind VM.AddTestLogCmd}" />
			<Button l:Uids.Uid="LogsPage_ClearViewButton" Command="{x:Bind VM.ClearViewCmd}" />
			<Button l:Uids.Uid="LogsPage_CopyButton" Click="OnCopyClick" />
			<Button l:Uids.Uid="LogsPage_ExportCsvButton" Command="{x:Bind VM.ExportCsvCmd}" />

			<Button l:Uids.Uid="LogsPage_DeleteAllButton" Command="{x:Bind VM.DeleteAllCmd}" />
		</StackPanel>

		<!-- 过滤工具条 -->
		<StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="8" Margin="0,0,0,12">
			<Button x:Name="FilterTimeButton" l:Uids.Uid="LogsPage_FilterTimeButton">
				<Button.Flyout>
					<Flyout>
						<views:LogsTimestampFilterFlyout x:Name="TimestampFilterFlyout" />
					</Flyout>
				</Button.Flyout>
			</Button>

			<Button x:Name="FilterLevelButton" l:Uids.Uid="LogsPage_FilterLevelButton">
				<Button.Flyout>
					<Flyout>
						<views:LogsLevelFilterFlyout x:Name="LevelFilterFlyout" />
					</Flyout>
				</Button.Flyout>
			</Button>

			<Button x:Name="FilterComponentButton" l:Uids.Uid="LogsPage_FilterComponentButton">
				<Button.Flyout>
					<Flyout>
						<views:LogsComponentFilterFlyout x:Name="ComponentFilterFlyout" />
					</Flyout>
				</Button.Flyout>
			</Button>

			<Button x:Name="FilterCategoryButton" l:Uids.Uid="LogsPage_FilterCategoryButton">
				<Button.Flyout>
					<Flyout>
						<views:LogsCategoryFilterFlyout x:Name="CategoryFilterFlyout" />
					</Flyout>
				</Button.Flyout>
			</Button>

			<Button x:Name="ResetFiltersButton" l:Uids.Uid="LogsPage_ResetFiltersButton" Click="OnResetFiltersClick" />
		</StackPanel>

		<!-- 文本流显示区域（类似 Logcat/记事本） -->
		<ScrollViewer Grid.Row="2" 
                      x:Name="LogsScrollViewer"
                      VerticalScrollMode="Auto"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollMode="Disabled"
                      HorizontalScrollBarVisibility="Disabled"
                      ZoomMode="Disabled"
                      Padding="0">
			<ItemsRepeater x:Name="LogsItemsRepeater"
                           ItemsSource="{x:Bind VM.Items, Mode=OneWay}"
                           ItemTemplate="{StaticResource LogItemTemplate}">
				<ItemsRepeater.Layout>
					<StackLayout Orientation="Vertical" Spacing="0"/>
				</ItemsRepeater.Layout>
			</ItemsRepeater>
		</ScrollViewer>

	</Grid>
</Page>
