# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [ main ]
  pull_request:

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€åˆ†æ”¯ä¸Šæ–°çš„ CI ä¼šå–æ¶ˆæ—§çš„ï¼ŒèŠ‚çœé…é¢
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1) Rust æ ¸å¿ƒï¼šæ ¼å¼åŒ– / é™æ€æ£€æŸ¥ / æµ‹è¯• / ä¾èµ–å®¡è®¡
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  rust:
    name: Rust Core
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ # å¦‚æœ core/ æ˜¯ workspace æˆå‘˜ï¼Œæ ¹ç›®å½•è·‘å°±è¡Œ
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # å¯é€‰ç¼“å­˜ï¼ŒåŠ é€Ÿ cargo æ„å»ºï¼ˆåç»­ä½ ä¹Ÿå¯ä»¥åŠ ä¸Š target ç¼“å­˜ï¼‰
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Format check (rustfmt)
        run: cargo fmt --all -- --check

      - name: Lint (clippy)
        run: cargo clippy --all-targets -- -D warnings

      - name: Test
        run: cargo test --all --verbose

      - name: Install cargo-deny
        run: cargo install cargo-deny || true

      - name: Audit (cargo-deny)
        run: cargo deny check

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2) Windows å¤–å£³ï¼šC++/WinUI 3 æ„å»º
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  windows_cpp:
    name: Windows C++ Shell
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # å¦‚æœå¤–å£³åœ¨æ„å»ºé˜¶æ®µéœ€è¦ Rust æ ¸å¿ƒ DLLï¼Œä½ å¯ä»¥å…ˆç¼–æ ¸å¿ƒï¼ˆReleaseï¼‰ï¼š
      # ï¼ˆè‹¥ä¸éœ€è¦å¯æ³¨é‡Šæ‰ä»¥ä¸‹æ­¥éª¤ï¼‰
      - name: Install Rust (optional for core DLL)
        uses: dtolnay/rust-toolchain@stable
      - name: Build Rust core (Release)  # å¦‚éœ€ï¼šæŠŠç”Ÿæˆçš„ DLL æ‹·åˆ°å¤–å£³å¯æ‰§è¡Œç›®å½•
        run: cargo build --package core --release
        shell: bash

      # é…ç½® MSBuildï¼ˆVS 2022 Build Tools å·²é¢„è£…äº windows-latestï¼‰
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # ğŸ”§ éœ€è¦ä½ æŒ‰å®é™…è·¯å¾„ä¿®æ”¹ï¼š
      #   å¦‚æœä½ æœ‰ .slnï¼Œç”¨ .sln æ›´å¥½ï¼›ä¸‹é¢ç¤ºä¾‹ç”¨ .vcxproj
      - name: Build WinUI3 project (Release x64)
        run: msbuild platforms\\windows\\ClipBridgeShell\\ClipBridgeShell.vcxproj /p:Configuration=Release /p:Platform=x64 /m
        shell: pwsh

      # å¯é€‰ï¼šä¸Šä¼ ç¼–è¯‘äº§ç‰©ï¼Œæ–¹ä¾¿ä» Actions ä¸‹è½½
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-shell-release
          path: |
            platforms/windows/ClipBridgeShell/x64/Release/**
            !**/*.pdb

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3) Androidï¼ˆJava å¤–å£³ï¼‰ï¼šLint + æ„å»º Debug APK
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  android_java:
    name: Android Java Shell
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # ğŸ”§ éœ€è¦ä½ æŒ‰å®é™…è·¯å¾„ä¿®æ”¹ï¼š-p åé¢æ˜¯ Android å·¥ç¨‹æ ¹
      - name: Lint
        run: ./gradlew -p platforms/android lint
      - name: Assemble Debug
        run: ./gradlew -p platforms/android assembleDebug

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-debug
          path: |
            platforms/android/app/build/outputs/apk/debug/*.apk
